var node_id=0;var folder_list=$(".folder-list");var current_url="";var file_cut,file_copy,target=null;$(function(){showFolderList(folder_list.data("url"));showFileList($(".file-list").data("url"));$("a#single_image").fancybox()});$(document).on("submit","form",function(a){a.preventDefault();return false});$(document).on("nodeSelected",".folder-list",function(b,a){reloadTreeview(a);showFileList(a.href)});$(document).on("click","[data-action='switch_view']",function(){$("[data-action='switch_view']").removeClass("btn-primary");$(this).addClass("btn-primary");$(".file-body").removeClass("thumb_view list_view").addClass($(this).data("name"));$(".first-row button,.first-row a").attr("disabled","disabled");$(".btn-file-preview").removeAttr("href");$(".btn-roxymce-select").attr("disabled","disabled");$("#txtSearch").val("");showFileList(current_url)});$(document).on("click",".file-list-item .thumb,.file-list-item .list",function(){var c=$(this);$(".file-list-item .thumb, .file-list-item .list").removeClass("selected");c.addClass("selected");$(".first-row button,.first-row a").removeAttr("disabled");$(".btn-file-download").attr("href",c.data("url")).attr("target","_blank");$(".btn-file-preview").attr("href",c.data("url")).attr("title",c.data("title")).fancybox({type:c.data("image")===1?"image":"iframe",padding:5,fitToView:true,autoSize:true});var b=folder_list.treeview("getSelected");var a=$("#file-rename");a.find("input[name='file']").val(c.data("title"));a.find("input[name='name']").val(c.data("title"));a.find("input[name='folder']").val(b[0].path);$(".btn-roxymce-select").removeAttr("disabled")});$(document).on("click","#folder-create .btn-submit",function(){var c=folder_list.treeview("getSelected");if(c.length!==0){var b=$(this);var a=b.closest(".modal").find("form");$.ajax({type:"GET",cache:false,data:a.serializeArray(),url:a.attr("action"),dataType:"json",success:function(d){if(d.error===0){var f=$("#folder-create");f.modal("hide");f.find("input[name='name']").val("");var e={text:d.data.text,href:d.data.href,path:d.data.path,icon:"glyphicon glyphicon-folder-close",selectedIcon:"glyphicon glyphicon-folder-open"};folder_list.treeview("addNode",[e,c])}else{alert(d.message)}},error:function(){alert(msg_somethings_went_wrong)}})}else{alert(msg_please_select_one_folder);$("#folder-create").modal("hide")}return false});$(document).on("click","#folder-rename .btn-submit",function(){var c=folder_list.treeview("getSelected");if(c.length!==0){var b=$(this);var a=b.closest(".modal").find("form");$.ajax({type:"GET",cache:false,data:a.serializeArray(),url:a.attr("action"),dataType:"json",success:function(d){if(d.error===0){$("#folder-rename").modal("hide");var e={text:d.data.text,href:d.data.href,path:d.data.path,icon:"glyphicon glyphicon-folder-close",selectedIcon:"glyphicon glyphicon-folder-open"};folder_list.treeview("updateNode",[c,e]).treeview("selectNode",[e,{silent:true}]);reloadTreeview(e)}else{alert(d.message)}},error:function(){alert(msg_somethings_went_wrong)}})}else{alert(msg_please_select_one_folder);$("#folder-rename").modal("hide")}return false});$(document).on("click","#file-rename .btn-submit",function(){var b=$(this);var a=b.closest(".modal").find("form");$.ajax({type:"GET",cache:false,data:a.serializeArray(),url:a.attr("action"),dataType:"json",success:function(c){if(c.error===0){var e=$("#file-rename");e.find("input[name='file']").val(c.data.name);e.modal("hide");var d=$(".file-list-item").find(".selected");d.find(".file-name").find("span").text(c.data.name);var g=d.data("url");var f=g.substring(0,g.lastIndexOf("/")+1)+c.data.name;d.data("title",c.data.name);d.data("url",f);d.find("img").data("original",f).attr("src",f);$(".btn-file-download").attr("href",f)}else{alert(c.message)}},error:function(){alert(msg_somethings_went_wrong)}});return false});$(document).on("click",".btn-folder-remove",function(){var c=folder_list.treeview("getSelected");var a=folder_list.treeview("getParents",c)[0];var b=confirm(msg_are_you_sure);if(b){$.ajax({type:"GET",cache:false,url:url_folder_remove+"?folder="+c[0].path,dataType:"json",success:function(d){if(d.error===0){folder_list.treeview("removeNode",[c,{silent:true}]).treeview("selectNode",[a,{silent:true}]);current_url=a.href;reloadTreeview(a);showFileList(current_url)}else{alert(d.message)}},error:function(){alert(msg_somethings_went_wrong)}})}});$(document).on("click",".btn-file-remove",function(){var a=confirm(msg_are_you_sure);var c=folder_list.treeview("getSelected");var b=$(".btn-file-preview").attr("title");if(a){$.ajax({type:"GET",cache:false,url:url_file_remove+"?folder="+c[0].path+"&file="+b,dataType:"json",success:function(d){if(d.error===0){var e=$(".file-list-item").find(".selected");if(e.hasClass("list")){e.fadeOut("normal",function(){$(this).remove()})}else{e.parent().fadeOut("normal",function(){$(this).remove()})}}else{alert(d.message)}reloadActionButton()},error:function(){alert(msg_somethings_went_wrong);reloadActionButton()}})}});$(document).on("change","input#uploadform-file",function(){$(".progress").show();var b=$(this);var a=b.prop("files");var c=new FormData();$.each(a,function(d,e){c.append("UploadForm[file][]",e)});$.ajax({type:"POST",url:b.attr("data-url"),cache:false,data:c,xhr:function(){var d=$.ajaxSettings.xhr();if(d.upload){d.upload.addEventListener("progress",progress,false)}return d},dataType:"json",processData:false,contentType:false,success:function(d){if(d.error===0){$(".image-list").append(d.html);showFileList(b.attr("data-href"))}else{alert(d.message)}},error:function(){alert(msg_somethings_went_wrong)}})});$(document).on("click",".btn-roxymce-close",function(){var a=(window.opener?window.opener:window.parent);if(a.tinyMCE){a.tinyMCE.activeEditor.windowManager.close()}closeDialog(getUrlParam("dialog"))});$(document).on("dblclick",".file-list-item .thumb,.file-list-item .list",function(){$(".btn-roxymce-select").click()});$(document).on("click",".btn-roxymce-select",function(){var c=(window.opener?window.opener:window.parent);var b=$(".file-list-item").find(".selected");var a=c.document.getElementById(getUrlParam("input"));a.value=b.attr("data-url");if(typeof(c.ImageDialog)!=="undefined"){if(c.ImageDialog.getImageData){c.ImageDialog.getImageData()}if(c.ImageDialog.showPreviewImage()){c.ImageDialog.showPreviewImage(b.attr("data-url"))}}if(c.tinyMCE){c.tinyMCE.activeEditor.windowManager.close()}closeDialog(getUrlParam("dialog"))});$(document).on("keyup","#txtSearch",function(){var b=$(this).val();var a=$(".file-list-item .item");a.show();$.each(a,function(d,c){var f=$(c).find(".file-name span").text();if(f.indexOf(b)<0){$(c).hide()}else{var e=new RegExp(b,"g");f=f.replace(e,'<b class="highlight">'+b+"</b>");$(c).find(".file-name span").html(f)}})});$(document).on("click",'[rel="order"]',function(){$('[rel="order"]').removeClass("sorted");var e=$(this).attr("data-order");var c=2;var a=false;var d=folder_list.treeview("getSelected");if($(this).attr("data-sort")==="desc"){$(this).addClass("sorted").attr("data-sort","asc");e+="_asc"}else{$(this).addClass("sorted").attr("data-sort","desc");e+="_desc"}switch(e){case"date_asc":c=1;break;case"date_desc":c=2;break;case"name_asc":c=3;break;case"name_desc":c=4;break;case"size_asc":c=5;break;case"size_desc":c=6;break;default:c=2;break}var b=d[0].href;$.each(parseQuery(b),function(g,f){if(g==="sort"){a=g+"="+f}});if(a){b=d[0].href.replace(a,"sort="+c)}else{b+="&sort="+c}showFileList(b)});$(".file-list-item")[0].oncontextmenu=function(d){target=$(d.target);var c=target.closest(".item");if(c.length>0){c.find(".list, .thumb").trigger("click")}else{target.closest(".file-list-item").find(".list, .thumb").removeClass("selected");$(".first-row button,.first-row a").attr("disabled","disabled");var b=$(".btn-file-preview");b.removeAttr("href").attr("title",b.text());var a=$(".btn-file-download");a.removeAttr("href").attr("title",a.text());$(".btn-roxymce-select").attr("disabled","disabled")}return false};$.contextMenu({selector:".file-list-item",items:{preview:{name:msg_preview,icon:"fa-search",callback:function(){$(".btn-file-preview").trigger("click")},disabled:function(){return target.closest(".item").length===0}},download:{name:msg_download,icon:"fa-download",callback:function(){$(".btn-file-download").trigger("click")},disabled:function(){return target.closest(".item").length===0}},separator:{type:"cm_separator"},cut:{name:msg_cut,icon:"fa-cut",callback:function(){var b=folder_list.treeview("getSelected");var a=$(".btn-file-preview").attr("title");$.ajax({type:"get",cache:false,dataType:"json",url:url_file_cut+"?folder="+b[0].path+"&file="+a,success:function(c){if(c.error===0){file_copy=false;file_cut=true}else{alert(c.message)}},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return target.closest(".item").length===0}},copy:{name:msg_copy,icon:"fa-copy",callback:function(){var b=folder_list.treeview("getSelected");var a=$(".btn-file-preview").attr("title");$.ajax({type:"get",cache:false,dataType:"json",url:url_file_copy+"?folder="+b[0].path+"&file="+a,success:function(c){if(c.error===0){file_cut=false;file_copy=true}else{alert(c.message)}},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return target.closest(".item").length===0}},paste:{name:msg_paste,icon:"fa-clipboard",callback:function(){var a=folder_list.treeview("getSelected");$.ajax({type:"get",cache:false,dataType:"json",url:url_file_paste+"?folder="+a[0].path,success:function(b){if(b.error===0){file_copy=false;file_cut=false;showFileList(a[0].href)}else{alert(b.message)}},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return !file_copy&&!file_cut}},rename:{name:msg_rename,icon:"fa-pencil",callback:function(){$(".btn-file-rename").trigger("click")},disabled:function(){return target.closest(".item").length===0}},remove:{name:msg_delete,icon:"fa-trash",callback:function(){$(".btn-file-remove").trigger("click")},disabled:function(){return target.closest(".item").length===0}}}});function showFileList(a){var b="";$(".file-list-item").html("");$("#txtSearch").val("");current_url=a;$.ajax({type:"GET",cache:false,dataType:"json",url:a,success:function(d){if(d.error===0){$.each(d.content,function(f,g){if($("button[data-name='thumb_view']").hasClass("btn-primary")){b+='<div class="item"><div class="col-sm-3">';b+='<div class="thumb" data-url="'+g.url+'" data-title="'+g.name+'" data-image='+g.is_image+">";b+='<div class="file-preview"><img class="lazy" data-original="'+g.preview+'"></div>';b+='<div class="file-name"><span>'+g.name+"</span></div>";b+='<div class="file-size">'+g.size+"</div>";b+="</div>";b+="</div>";b+="</div>";$(".sort-actions").hide()}else{b+='<div class="item"><div class="row list" data-url="'+g.url+'" data-title="'+g.name+'" data-image='+g.is_image+">";b+='<div class="col-sm-7 file-name"><img class="icon" src="'+g.icon+'"><span>'+g.name+"</span></div>";b+='<div class="col-sm-2 file-size">'+g.size+"</div>";b+='<div class="col-sm-3 file-date">'+g.date+"</div>";b+="</div>";b+="</div>";$(".sort-actions").show()}});if(b===""){b=msg_empty_directory}var c=$(".file-list-item");c.html(b);$("img.lazy").lazyload({container:c,effect:"fadeIn"})}else{alert(d.message);$(".file-list-item").html(msg_empty_directory)}},error:function(){alert(msg_somethings_went_wrong);$(".file-list-item").html(msg_empty_directory)}})}function showFolderList(a){$.ajax({type:"GET",cache:false,dataType:"json",url:a,success:function(b){if(b.error===0){folder_list.treeview({data:b.content,preventUnselect:true});var d=folder_list.treeview("getNodes",node_id);var c=$("#folder-rename");c.find("input[name='folder']").val(d.path);c.find("input#folder_name").val(d.text)}else{alert(b.message)}},error:function(){alert(msg_somethings_went_wrong)}});return folder_list}function getUrlParam(e,b){var a="";if(!b){b=self.location.href}if(b.indexOf("?")>-1){b=b.substr(b.indexOf("?")+1);b=b.split("&");for(var d=0;d<b.length;d++){var c=b[d].split("=");if(c[0]&&c[1]&&c[0]===e){a=c[1];break}}}return a}function parseQuery(b){var e=b.split("&");var a=[];for(var c=0;c<e.length;c++){var g=e[c].split("=");var f=decodeURIComponent(g[0]);if(f.indexOf("?")>=0){f=f.split("?")[1]}var d=decodeURIComponent(g[1]);a.push({name:f,value:d})}return a}function progress(d){if(d.lengthComputable){var a=d.total;var c=d.loaded;var b=Math.round((c*100)/a);$(".progress-bar").css({width:b+"%"}).html(b+"%");if(b>=100){setTimeout(function(){$(".progress").fadeOut("normal",function(){$(".progress-bar").css({width:"0%"}).html("0%")})},1000)}}}function reloadTreeview(a){node_id=a.nodeId;$("#folder-rename").find("input[name='folder']").val(a.path).parent().find("input[name='name']").val(a.text);$("#folder-create").find("input[name='folder']").val(a.path);$("#uploadform-file").attr("data-url",url_file_upload+"?folder="+a.path).attr("data-href",a.href);$("#txtSearch").val("");reloadActionButton()}function reloadActionButton(){$(".first-row button,.first-row a").attr("disabled","disabled");var b=$(".btn-file-preview");b.removeAttr("href").attr("title",b.text());var a=$(".btn-file-download");a.removeAttr("href").attr("title",a.text());$(".btn-roxymce-select").attr("disabled","disabled")}function closeDialog(b){switch(b){case"fancybox":parent.$.fancybox.close();$.fancybox.close();break;case"modal":var a=parent.$(".modal-roxy").attr("id");parent.$("#"+a).modal("hide");break}};